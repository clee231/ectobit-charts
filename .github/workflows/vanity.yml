name: vanity

on:
  push:
    branches:
      - main
  #   paths:
  #     - 'vanity/**'
  # pull_request:
  #   paths:
  #     - 'vanity/**'

jobs:
  vanity:
    runs-on: ubuntu-latest
    env:
      CHART: vanity
    steps:
      - name: Set up Helm
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh
      - name: Check out
        uses: actions/checkout@v2
      - name: Lint
        run: |
          helm lint ${{ env.CHART }}
      - name: Configure GPG key
        env:
          GPG_SIGNING_KEY: ${{ secrets.GPG_SIGNING_KEY }}
        run: |
          set -ex
          mkdir -p ~/.gnupg/
          printf "${GPG_SIGNING_KEY}" | base64 -d > ~/.gnupg/pubring.gpg
          # gpg --import ~/.gnupg/pubring.gpg
      - name: Release
        run: |
          PATH=$(helm package --sign --key 'Boban Acimovic' ${{ env.CHART }})
          FILE=$(basename ${PATH})
          curl -u "${{secrets.HELM_REPO_USERNAME}}:${{secrets.HELM_REPO_PASSWORD}}" -F "chart=@${FILE}" -F "prov=@${FILE}.prov" https://charts.ectobit.com/api/charts
